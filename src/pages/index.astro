---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import HeroSection from '../components/home/HeroSection.astro';
import WelcomeSection from '../components/home/WelcomeSection.astro';
import FeaturedPotentials from '../components/home/FeaturedPotentials.astro';
import FeaturedTourism from '../components/home/FeaturedTourism.astro';
import FeaturedGallery from '../components/home/FeaturedGallery.astro';

import { getCollection } from 'astro:content';
import { getImage } from 'astro:assets';
import type { ImageMetadata } from 'astro';

import homepageData from '../data/index.json';
import galleryData from '../data/galeri.json'; // <-- Import main gallery data

const allImages = await import.meta.glob<{ default: ImageMetadata }>('/src/assets/images/**/*.{jpeg,jpg,png,gif,webp,svg}');

// Fetch content for other sections
const featuredPotensi = (await getCollection('potensi')).sort((a, b) => a.data.judul.localeCompare(b.data.judul)).slice(0, 3);
const featuredPariwisata = (await getCollection('pariwisata')).slice(0, 4);

// --- NEW: Process featured gallery photos ---
const featuredPhotos = galleryData.foto.slice(0, 4); // Take the first 4 photos

const processedFeaturedPhotos = await Promise.all(
    featuredPhotos.map(async (photo) => {
        const imagePath = Object.keys(allImages).find(path => path.endsWith(photo.url));
        if (!imagePath) return null;

        const originalImage = allImages[imagePath];
        const lightboxImage = await getImage({ src: originalImage(), width: 1200, format: 'webp' });

        return {
            alt: photo.alt,
            originalSrc: originalImage,
            lightboxSrc: lightboxImage.src,
        };
    })
).then(results => results.filter(item => item !== null));
---
<Layout 
    title="Dusun Bedalo"
    description="Temukan pesona tersembunyi Dusun Bedalo di Gunung Kidul. Jelajahi Pantai Ngedan yang eksotis, cicipi kuliner lokal, dan kenali budaya kami. Rencanakan kunjungan Anda!"
>
    <Header currentPage="Beranda" />

    <main>
        <HeroSection hero={homepageData.hero} allImages={allImages} />

        <WelcomeSection profile={homepageData.profilSingkat} allImages={allImages} />

        <FeaturedPotentials potentials={featuredPotensi} />

        <FeaturedTourism tourism={featuredPariwisata} allImages={allImages} />
        
        {/* Pass the processed photos to the component */}
        <FeaturedGallery photos={processedFeaturedPhotos} />
    </main>

    <Footer />
</Layout>