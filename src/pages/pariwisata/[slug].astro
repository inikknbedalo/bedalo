---
import { getCollection, type CollectionEntry } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import PageBanner from '../../components/PageBanner.astro';
import SectionTitle from '../../components/SectionTitle.astro';
import PhotoGallery from '../../components/PhotoGallery.astro';
import Card from '../../components/Card.astro';
import { Image, getImage } from 'astro:assets';
import type { ImageMetadata } from 'astro';

export async function getStaticPaths() {
  const pariwisataEntries = await getCollection('pariwisata');
  return pariwisataEntries.map(entry => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props as { entry: CollectionEntry<'pariwisata'> };
const { data } = entry;
const allImages = await import.meta.glob<{ default: ImageMetadata }>('/src/assets/images/**/*.{jpeg,jpg,png,gif,webp,svg}');
const imagePath = Object.keys(allImages).find(path => path.endsWith(data.coverImage));

const processedPhotos = data.gallery ?
await Promise.all(
    data.gallery.map(async (photo) => {
        const imagePath = Object.keys(allImages).find(path => path.endsWith(photo.url));
        if (!imagePath) return null;
        const originalImage = allImages[imagePath];
        const lightboxImage = await getImage({ src: originalImage(), width: 1200, format: 'webp' });
        return {
            alt: photo.alt,
            originalSrc: originalImage,
            lightboxSrc: lightboxImage.src,
        };
    })
).then(results => results.filter(item => item !== null)) : [];
---

<Layout title={data.judul} description={data.deskripsi}>
    <Header currentPage="Pariwisata" />
    <main>
        <PageBanner
            title={data.judul}
            subtitle="Destinasi Wisata Dusun Bedalo"
            bgColor="bg-purple-600"
        />

        <section class="py-20 bg-white">
            <div class="container mx-auto px-6 max-w-4xl">

                <!-- --- BACK BUTTON ADDED HERE --- -->
                <div class="mb-8">
                    <a href="/pariwisata" class="inline-flex items-center gap-2 text-blue-600 hover:text-blue-800 hover:underline transition-colors font-semibold">
                        <i class="fas fa-arrow-left"></i>
                        Kembali ke Daftar Pariwisata
                    </a>
                </div>
       
                <div class="grid md:grid-cols-2 gap-12 items-center">
                    <div data-aos="fade-right">
                        {imagePath && (
                            <Image
                                src={allImages[imagePath]()}
                                alt={data.altText}
                                width="800"
                                height="600"
                                class="rounded-xl shadow-lg w-full h-full object-cover"
                            />
                        )}
                    </div>
                    <div data-aos="fade-left">
                        <h2 class="text-3xl font-bold text-gray-800 mb-4">Tentang {data.judul}</h2>
                        <p class="text-gray-600 leading-relaxed mb-6">{data.deskripsi}</p>
                        <a href={data.petaLink} target="_blank" rel="noopener noreferrer" class="inline-block bg-blue-600 text-white px-6 py-3 rounded-md font-semibold hover:bg-blue-700 transition duration-300">
                            <i class="fas fa-map-marker-alt mr-2"></i>
                            Lihat di Peta
                        </a>
                    </div>
                </div>
            </div>
        </section>

        <!-- UMKM Section -->
        {data.umkm && data.umkm.length > 0 && (
            <section class="py-20 bg-gray-50">
                <div class="container mx-auto px-6 max-w-6xl">
                    <SectionTitle title="UMKM Lokal" subtitle="Layanan dan produk dari warga setempat" />
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                        {data.umkm.map((item, index) => {
                            // Create a slug for the UMKM item
                            const umkmSlug = encodeURIComponent(item.nama.toLowerCase().replace(/\s+/g, '-'));
                            
                            return (
                                <div data-aos="fade-up" data-aos-delay={100 + index * 50}>
                                    <Card
                                        title={item.nama}
                                        description={item.deskripsi}
                                        price={item.harga}
                                        imageUrl={item.gambarUrl || data.coverImage}
                                        altText={item.nama}
                                        linkUrl={`/pariwisata/${entry.slug}/umkm/${umkmSlug}`}
                                        linkText="Lihat Detail"
                                        allImages={allImages}
                                    >
                                        <div class="mt-3">
                                            <span class="inline-block px-3 py-1 text-xs font-semibold text-white bg-gray-600 rounded-full">
                                                {item.jenis.charAt(0).toUpperCase() + item.jenis.slice(1)}
                                            </span>
                                        </div>
                                    </Card>
                                </div>
                            );
                        })}
                    </div>
                </div>
            </section>
        )}

        <!-- Accommodation Section -->
        {data.umkm && data.umkm.length > 0 && data.umkm.some(item => item.jenis === "penginapan") && (
            <section class="py-20 bg-white">
                <div class="container mx-auto px-6 max-w-6xl">
                    <SectionTitle title="Akomodasi" subtitle="Tempat menginap di sekitar destinasi wisata" />
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                        {data.umkm
                          .filter(item => item.jenis === "penginapan")
                          .map((item, index) => {
                            // Create a slug for the UMKM item
                            const umkmSlug = encodeURIComponent(item.nama.toLowerCase().replace(/\s+/g, '-'));
                            
                            return (
                                <div data-aos="fade-up" data-aos-delay={100 + index * 50}>
                                    <Card
                                        title={item.nama}
                                        description={item.deskripsi}
                                        price={item.harga}
                                        imageUrl={item.gambarUrl || data.coverImage}
                                        altText={item.nama}
                                        linkUrl={`/pariwisata/${entry.slug}/umkm/${umkmSlug}`}
                                        linkText="Lihat Detail"
                                        allImages={allImages}
                                    >
                                        <div class="mt-3">
                                            <span class="inline-block px-3 py-1 text-xs font-semibold text-white bg-blue-600 rounded-full">
                                                {item.jenis.charAt(0).toUpperCase() + item.jenis.slice(1)}
                                            </span>
                                        </div>
                                    </Card>
                                </div>
                            );
                        })}
                    </div>
                </div>
            </section>
        )}

        {processedPhotos.length > 0 && (
            <section class="py-20">
                <div class="container mx-auto px-6 max-w-6xl">
                    <SectionTitle title={`Galeri Foto ${data.judul}`} />
                    <PhotoGallery fotoItems={processedPhotos} />
                </div>
            </section>
        )}
    </main>
    <Footer />
</Layout>